commands:
  01_install_certbot:
    command: |
      sudo dnf install -y augeas-libs python3-pip
      sudo python3 -m venv /opt/certbot/
      sudo /opt/certbot/bin/pip install --upgrade pip
      sudo /opt/certbot/bin/pip install certbot certbot-nginx
      sudo ln -sf /opt/certbot/bin/certbot /usr/bin/certbot
    test: "[ ! -f /usr/bin/certbot ]"

files:
  "/tmp/setup_https.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      set -x
      exec > /var/log/certbot_setup.log 2>&1
      
      # Wait for nginx to be ready
      sleep 10
      systemctl status nginx
      
      # Check if certificate already exists
      if [ -d "/etc/letsencrypt/live/${CERTBOT_DOMAIN}" ]; then
        echo "Certificate exists, attempting renewal..."
        certbot renew --nginx --non-interactive --deploy-hook "systemctl restart nginx"
      else
        echo "Obtaining new certificate..."
        certbot --nginx \
          --non-interactive \
          --agree-tos \
          --email ${CERTBOT_EMAIL} \
          --domains ${CERTBOT_DOMAIN} \
          --redirect \
          --deploy-hook "systemctl restart nginx"
      fi
      
      # Force nginx restart to apply changes
      systemctl restart nginx
      sleep 3
      
      # Verify nginx is listening on 443
      if netstat -tuln | grep :443; then
        echo "SUCCESS: nginx is listening on port 443"
      else
        echo "ERROR: nginx not listening on 443"
        exit 1
      fi

container_commands:
  01_run_certbot:
    command: "/tmp/setup_https.sh"
  
  02_verify_nginx:
    command: "systemctl restart nginx && sleep 2 && netstat -tuln | grep :443"
  
  03_setup_auto_renewal:
    command: |
      echo "0 0,12 * * * root certbot renew --quiet --nginx --deploy-hook 'systemctl restart nginx'" | tee /etc/cron.d/certbot-renew
      chmod 644 /etc/cron.d/certbot-renew