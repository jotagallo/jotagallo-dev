commands:
  01_install_certbot:
    command: |
      sudo dnf install -y augeas-libs python3-pip
      sudo python3 -m venv /opt/certbot/
      sudo /opt/certbot/bin/pip install --upgrade pip
      sudo /opt/certbot/bin/pip install certbot certbot-nginx
      sudo ln -sf /opt/certbot/bin/certbot /usr/bin/certbot
    test: "[ ! -f /usr/bin/certbot ]"

container_commands:
  01_obtain_certificate:
    command: |
      CERTBOT_EMAIL=$(/opt/elasticbeanstalk/bin/get-config environment -k CERTBOT_EMAIL)
      CERTBOT_DOMAIN=$(/opt/elasticbeanstalk/bin/get-config environment -k CERTBOT_DOMAIN)
      
      echo "Certbot Email: ${CERTBOT_EMAIL}" > /var/log/certbot_deploy.log
      echo "Certbot Domain: ${CERTBOT_DOMAIN}" >> /var/log/certbot_deploy.log
      
      if [ -d "/etc/letsencrypt/live/${CERTBOT_DOMAIN}" ]; then
        echo "Certificate exists, skipping..." >> /var/log/certbot_deploy.log
      else
        sudo certbot --nginx \
          --non-interactive \
          --agree-tos \
          --email ${CERTBOT_EMAIL} \
          --domains ${CERTBOT_DOMAIN} \
          --redirect >> /var/log/certbot_deploy.log 2>&1
        
        echo "Certbot exit code: $?" >> /var/log/certbot_deploy.log
      fi
      
      sudo systemctl restart nginx
      sleep 2
      
      sudo netstat -tuln | grep :443 >> /var/log/certbot_deploy.log || echo "Port 443 not listening!" >> /var/log/certbot_deploy.log
      sudo certbot certificates >> /var/log/certbot_deploy.log 2>&1
  
  02_setup_auto_renewal:
    command: |
      echo "0 0,12 * * * root certbot renew --quiet --nginx" > /etc/cron.d/certbot-renew
      chmod 644 /etc/cron.d/certbot-renew