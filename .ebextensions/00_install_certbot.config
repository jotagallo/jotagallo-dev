commands:
  01_install_certbot:
    command: |
      sudo dnf install -y augeas-libs
      sudo python3 -m venv /opt/certbot/
      sudo /opt/certbot/bin/pip install --upgrade pip
      sudo /opt/certbot/bin/pip install certbot certbot-nginx
      sudo ln -sf /opt/certbot/bin/certbot /usr/bin/certbot
    test: "[ ! -f /usr/bin/certbot ]"

container_commands:
  01_stop_certbot_timer:
    command: "sudo systemctl stop certbot-renew.timer || true"
    ignoreErrors: true
  
  02_obtain_or_renew_cert:
    command: |
      sudo certbot --nginx \
        --non-interactive \
        --agree-tos \
        --email ${CERTBOT_EMAIL} \
        --domains ${CERTBOT_DOMAIN} \
        --redirect \
        --keep-until-expiring \
        --deploy-hook "sudo systemctl reload nginx"
    ignoreErrors: false
  
  03_setup_auto_renewal:
    command: |
      echo "0 0,12 * * * root /opt/certbot/bin/python -c 'import random; import time; time.sleep(random.random() * 3600)' && sudo certbot renew --quiet --deploy-hook 'sudo systemctl reload nginx'" | sudo tee /etc/cron.d/certbot-renew
      sudo chmod 644 /etc/cron.d/certbot-renew